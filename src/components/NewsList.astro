---
import { getCollection } from 'astro:content';

const { limit = 5, title = 'News & Highlights' } = Astro.props;
const PINNED_LIMIT = 3;

// sort newest → oldest
const entries = (await getCollection('news'))
  .sort((a, b) => +b.data.date - +a.data.date);

const pinnedRaw = entries.filter((entry) => entry.data.pinned).slice(0, PINNED_LIMIT);
const others = entries.filter((entry) => !entry.data.pinned);
const topRaw  = others.slice(0, limit);
const restRaw = others.slice(limit);

// pre-render markdown
const renderBatch = async (arr) =>
  Promise.all(arr.map(async (e) => {
    const R = await e.render();
    return { entry: e, Content: R.Content };
  }));

const pinned = await renderBatch(pinnedRaw);
const top  = await renderBatch(topRaw);
const rest = await renderBatch(restRaw);

// unique id for aria-controls
const uid = 'news_' + Math.random().toString(36).slice(2, 8);

const fmt = (d: Date | string) =>
  new Date(d).toLocaleDateString('en-CA', { year: 'numeric', month: 'short', day: 'numeric' });
---
<section class="mt-10" aria-labelledby={`${uid}-heading`}>
  <div class="mb-3 flex items-baseline gap-4">
    <h2 id={`${uid}-heading`} class="text-xl font-semibold">{title}</h2>

    {(restRaw.length > 0) && (
      <button
        type="button"
        class="inline-flex items-center gap-2 font-semibold text-600 hover:text-blue-700"
        data-news-toggle
        aria-expanded="false"
        aria-controls={`${uid}-rest`}
      >
        <span aria-hidden="true">›</span>
        <span class="underline underline-offset-4 decoration-2">Show all</span>
      </button>
    )}
  </div>

  {pinned.length > 0 && (
    <div class="mb-6">
      <p class="text-xs uppercase tracking-[0.2em] text-gray-500 mb-2">Pinned highlights</p>
      <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        {pinned.map(({ entry, Content }) => (
          <article class="rounded-xl border border-indigo-200/80 bg-indigo-50/80 p-4 shadow-sm ring-1 ring-indigo-100/80">
            <div class="flex items-center justify-between text-xs uppercase tracking-wider text-indigo-800">
              <span class="inline-flex items-center gap-1 font-semibold">
                <svg viewBox="0 0 20 20" fill="currentColor" class="h-3.5 w-3.5">
                  <path d="M7.5 1.5a1 1 0 0 0-1 1v4.086a1 1 0 0 1-.293.707L4.5 9a1 1 0 0 0 .707 1.707H7v6.793a1 1 0 0 0 1.707.707l2-2a1 1 0 0 0 .293-.707V10.707l1.293-1.293A1 1 0 0 0 12.586 8h-1.086V2.5a1 1 0 0 0-1-1h-3z"/>
                </svg>
                Pinned
              </span>
              <time datetime={new Date(entry.data.date).toISOString()} class="font-semibold text-indigo-700">
                {fmt(entry.data.date)}
              </time>
            </div>
            <div class="prose prose-sm max-w-none mt-2">
              <Content />
            </div>
          </article>
        ))}
      </div>
    </div>
  )}

  <div class="overflow-x-auto rounded-xl border">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50 text-gray-600">
        <tr>
          <th class="px-3 py-2 text-left w-36">Date</th>
          <th class="px-3 py-2 text-left">News</th>
        </tr>
      </thead>

      <!-- Top N -->
      <tbody class="divide-y">
        {top.map(({ entry, Content }) => (
          <tr id={entry.slug}>
            <td class="whitespace-nowrap px-3 py-2 text-gray-600 align-top">
              <time datetime={new Date(entry.data.date).toISOString()} class="tabular-nums">
                {fmt(entry.data.date)}
              </time>
            </td>
            <td class="px-3 py-2 align-top">
              <div class="prose prose-sm max-w-none">
                <Content />
              </div>
            </td>
          </tr>
        ))}
      </tbody>

      <!-- Rest (hidden until toggled) -->
      {rest.length > 0 && (
      <tr>
        <td colspan="2" class="p-0">
          <div
            id={`${uid}-rest`}
            class="overflow-hidden max-h-0 opacity-0 transition-[max-height,opacity] duration-300 ease-out"
            data-news-panel
          >
            <table class="min-w-full text-sm">
              <tbody class="divide-y">
                {rest.map(({ entry, Content }) => (
                  <tr id={entry.slug}>
                    <td class="whitespace-nowrap px-3 py-2 text-gray-600 align-top">
                      <time datetime={new Date(entry.data.date).toISOString()} class="tabular-nums">
                        {fmt(entry.data.date)}
                      </time>
                    </td>
                    <td class="px-3 py-2 align-top">
                      <div class="prose prose-sm max-w-none">
                        <Content />
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </td>
      </tr>
    )}
    </table>
  </div>
</section>
