---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import PubTile from "../components/PubTile.astro";
import NewsList from "../components/NewsList.astro";
import ProspectiveStudents from '../components/ProspectiveStudents.astro';
import { getCollectionName, focusHref } from "../data/focusCollections";


const TILE_COUNT = 6;
const SHOW_PEOPLE = true; // ← turn it back on

const pubs = await getCollection("pubs");
const peopleAll = await getCollection("people");

// sort & pick active folks (skip alumni), show first 18
const people = peopleAll
  .filter(p => (p.data.status ?? '').toLowerCase() !== 'alum')
  .sort((a,b) => (a.data.order ?? 999) - (b.data.order ?? 999))
  .slice(0, 18);

const avatar = (p) => p.data.image ?? "/images/placeholder-avatar.svg";

const monthToNum = (m) =>
  typeof m === "number" ? m :
  typeof m === "string" ? new Date(`${m} 1, 2000`).getMonth() + 1 : 12;

const byDateDesc = (a, b) =>
  (b.data.year - a.data.year) ||
  (monthToNum(b.data.month) - monthToNum(a.data.month));

const recentTiles = pubs.sort(byDateDesc).slice(0, TILE_COUNT);
// import { getCollection } from 'astro:content';
import FocusGrid from "../components/FocusGrid.astro";

const focusMeta = (await getCollection('focus_meta'))
  .sort((a,b) => (a.data.order ?? 999) - (b.data.order ?? 999));

const focusItems = await Promise.all(focusMeta.map(async (entry) => {
  const collectionName = getCollectionName(entry.slug);
  let gallery = [];
  if (collectionName) {
    const items = await getCollection(collectionName);
    gallery = items
      .sort((a,b) => (a.data.order ?? 999) - (b.data.order ?? 999))
      .slice(0, 6)
      .map((item) => ({
        image: item.data.image,
        label: item.data.title,
        alt: item.data.title,
        href: `${focusHref(entry.slug)}#${entry.slug}-${item.slug}`,
      }));
  }

  return {
    title: entry.data.title,
    image: entry.data.image,
    kicker: entry.data.kicker,
    blurb: entry.data.blurb,
    href: focusHref(entry.slug),
    gallery,
    slug: entry.slug,
  };
}));
---
<BaseLayout title="TCIG/CIPS" noTopPad>
  <section
	class="relative w-screen left-1/2 right-1/2 -ml-[50vw] -mr-[50vw] mb-8 overflow-hidden bg-black"
	aria-label="Hero"
	>
	<!-- Background video (pillarboxed) -->
	<video
		class="absolute inset-y-0 left-1/2 -translate-x-1/2 h-full w-auto max-w-none object-contain"
		autoplay
		muted
		loop
		playsinline
		preload="metadata"
		poster=""
		aria-hidden="true"
	>
		<source src="/tcig_lensed.mp4" type="video/mp4" />
		<!-- Fallback image if video can't play -->
		<img
		src=""
		alt=""
		class="absolute inset-y-0 left-1/2 -translate-x-1/2 h-full w-auto max-w-none object-contain"
		/>
	</video>

	<!-- Top gradient for white text readability -->
	<div class="absolute inset-0 bg-gradient-to-b from-black/70 via-black/30 to-transparent"></div>

	<!-- Set hero height -->
	<div class="h-[14vh] min-h-[120px] sm:h-[14vh] md:h-[14vh]"></div>

	<!-- Top-aligned title -->
	<div class="pointer-events-auto absolute inset-x-0 top-0 z-10">
		<div class="mx-auto max-w-6xl px-4 pt-6 sm:pt-8 md:pt-10">
		<h1 class="text-white drop-shadow-lg [text-wrap:balance] text-3xl sm:text-4xl font-bold leading-tight">
			<span>Physics-Informed Vision and Imaging</span>
		</h1>
		</div>
	</div>
	</section>

    {SHOW_PEOPLE && (
	<div class="mb-6 flex items-center gap-3">
		<div class="flex flex-wrap items-center gap-[2px]">
		{people.map((p) => (
			<a href={`/people/#${p.slug}`} class="block group" aria-label={p.data.name} title={p.data.name}>
			<div
				class="h-10 w-10 rounded-xl overflow-hidden ring-1 ring-black/10 transition duration-200
					group-hover:ring-blue-400 group-hover:brightness-105"
				transition:name={`person-${p.slug}`}     
			>
				<img
				src={avatar(p)}
				alt={p.data.name}
				class="h-full w-full object-cover"
				loading="lazy"
				/>
			</div>
			</a>
		))}
		</div>

		{peopleAll.length > people.length && (
		<span class="text-sm text-gray-600">+{peopleAll.length - people.length}</span>
		)}
		<a
			href="/people/"
			class="inline-flex items-center gap-2 font-semibold text-600 hover:text-blue-700"
		>
			<span aria-hidden="true" class="select-none">›</span>
			<span class="underline underline-offset-4 decoration-2">Our members</span>
		</a>
	</div>
	)}

    <!-- Group description -->
    <div class="prose max-w-none mb-8">
      <p><strong>Physics-Informed Vision and Imaging</strong> is a research group focused on advancing the science of imaging through novel sensors, physics-aware computation, and machine learning. We push the limits of what can be seen — revealing new insights about our world and the cosmos.</p>
    </div>

	<FocusGrid items={focusItems} />

     <!-- Recent Publications (grid) -->
	<div class="mb-3 flex items-baseline gap-4">
		<h2 class="text-xl font-semibold">Recent Publications</h2>
		<a
			href="/publications/"
			class="inline-flex items-center gap-2 font-semibold text-600 hover:text-blue-700"
		>
			<span aria-hidden="true" class="select-none">›</span>
			<span class="underline underline-offset-4 decoration-2">View all publications</span>
		</a>
	</div>

    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
      {recentTiles.map(p => (
		<PubTile
			entry={p}
			to={`/publications/#${p.slug}`}          // enables home tile → publications tile
			suppressTitleTransition={false}           // ok here; no duplicates on the home page
		/>
		))}
    </div>

	<NewsList limit={10} />

	<!-- <ProspectiveStudents
		email="your.name@utoronto.ca"
		links={[
		{ label: "U of T Graduate Admissions", href: "https://www.sgs.utoronto.ca/future-students/applying/" },
		{ label: "Dept. of Computer Science (DCS) Admissions", href: "https://web.cs.toronto.edu/graduate/prospective" },
		]}
	/> -->

  <!-- Tiny script to handle the buttons + keyboard -->
  <script>
    const track = document.getElementById('pub-track');
    const left = document.querySelector('[data-action="scroll-left"]');
    const right = document.querySelector('[data-action="scroll-right"]');

    const step = () => {
      // Scroll ~one card at a time based on the first child width
      const first = track?.querySelector(':scope > *');
      return first ? first.getBoundingClientRect().width + 16 /* gap */ : 320;
    };

    left?.addEventListener('click', () => {
      track?.scrollBy({ left: -step(), behavior: 'smooth' });
    });
    right?.addEventListener('click', () => {
      track?.scrollBy({ left: step(), behavior: 'smooth' });
    });

    // Keyboard accessibility: arrow keys when the track is focused
    track?.setAttribute('tabindex', '0');
    track?.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight') {
        e.preventDefault();
        track.scrollBy({ left: step(), behavior: 'smooth' });
      } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        track.scrollBy({ left: -step(), behavior: 'smooth' });
      }
    });
  </script>
</BaseLayout>
