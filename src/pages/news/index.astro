---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const entries = (await getCollection("news")).sort(
  (a, b) => +new Date(b.data.date) - +new Date(a.data.date)
);

const pinned = entries.filter((entry) => entry.data.pinned);
const rest = entries;

const fmt = (d: Date | string) =>
  new Date(d).toLocaleDateString("en-CA", {
    year: "numeric",
    month: "short",
    day: "numeric",
  });

const renderBatch = async (arr) =>
  Promise.all(
    arr.map(async (entry) => {
      const R = await entry.render();
      return { entry, Content: R.Content };
    })
  );

const pinnedRendered = await renderBatch(pinned);
const restRendered = await renderBatch(rest);
---
<BaseLayout title="News & Highlights">
  <div class="mb-8">
    <h1 class="text-3xl font-semibold">News & Highlights</h1>
  </div>

  {pinnedRendered.length > 0 && (
    <section class="mb-10">
      <p class="text-xs uppercase tracking-[0.3em] text-gray-500 mb-2">Pinned highlights</p>
      <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        {pinnedRendered.map(({ entry, Content }) => (
          <article class="rounded-xl border border-indigo-200/80 bg-indigo-50/80 p-4 shadow-sm ring-1 ring-indigo-100/80">
            <div class="flex items-center justify-between text-xs uppercase tracking-wider text-indigo-800">
              <span class="inline-flex items-center gap-1 font-semibold">
                <svg viewBox="0 0 20 20" fill="currentColor" class="h-3.5 w-3.5">
                  <path d="M7.5 1.5a1 1 0 0 0-1 1v4.086a1 1 0 0 1-.293.707L4.5 9a1 1 0 0 0 .707 1.707H7v6.793a1 1 0 0 0 1.707.707l2-2a1 1 0 0 0 .293-.707V10.707l1.293-1.293A1 1 0 0 0 12.586 8h-1.086V2.5a1 1 0 0 0-1-1h-3z" />
                </svg>
                Pinned
              </span>
              <time datetime={new Date(entry.data.date).toISOString()} class="font-semibold text-indigo-700">
                {fmt(entry.data.date)}
              </time>
            </div>
            <div class="prose prose-sm max-w-none mt-2">
              <Content />
            </div>
          </article>
        ))}
      </div>
    </section>
  )}

  <section class="border rounded-xl overflow-hidden">
    <div class="bg-gray-50 border-b px-4 py-3">
      <p class="text-sm font-semibold text-gray-700">All news</p>
    </div>
    <div class="divide-y">
      {restRendered.map(({ entry, Content }) => (
        <article id={entry.slug} class="px-4 py-4 flex flex-col gap-1 sm:flex-row sm:items-baseline sm:gap-6">
          <time datetime={new Date(entry.data.date).toISOString()} class="text-sm font-mono text-gray-500 w-40 shrink-0">
            {fmt(entry.data.date)}
          </time>
          <div class="prose prose-sm max-w-none text-gray-800">
            <Content />
          </div>
        </article>
      ))}
    </div>
  </section>
</BaseLayout>
