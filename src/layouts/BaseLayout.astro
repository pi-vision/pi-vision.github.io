---
// src/layouts/BaseLayout.astro
import '../styles/tailwind.css';
import { ClientRouter } from 'astro:transitions';
const { title = 'PI-Vision', noTopPad = false } = Astro.props;
---

<html lang="en" data-astro-transition>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" href="/pivision-logo.svg" type="image/svg+xml" />
    <link rel="icon" href="/pivision-logo_32x32.png" sizes="32x32" type="image/png" />
    <link rel="icon" href="/pivision-logo_16x16.png" sizes="16x16" type="image/png" />
    <title>{title}</title>
    <!-- SPA routing + view transitions -->
    <ClientRouter/>  <!-- rely on named transitions only -->
    <style>
      /* Critical clamp to prevent title flash (2 lines) */
      .vt-clamp-2 {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
        line-height: 1.25;
        max-height: 2.5em; /* 2 × line-height */
      }
      ::view-transition-old(focus-*) ,
      ::view-transition-new(focus-*) {
        border-radius: 1rem; /* rounded-2xl */
        overflow: hidden;
      }
      #mobile-menu[data-open="true"] { transform: scaleY(1); }
      #mobile-menu[data-open="false"] { transform: scaleY(0); }
      html, body { overflow-x: clip; }
    </style>
  </head>
  <body class="min-h-screen bg-white text-gray-900">
    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b" transition:persist>
      <div class="relative">
        <nav class="mx-auto max-w-6xl px-4 py-2 flex items-center justify-between min-h-[48px]">
          <!-- Brand -->
          <a href="/" class="flex items-center gap-3">
            <img src="/logo.svg" alt="" class="h-10 w-10" transition:name="logo" />
            <span class="font-semibold text-lg" transition:name="brand">PI-Vision</span>
          </a>

          <!-- Desktop nav -->
          <ul class="hidden md:flex items-center gap-6 text-sm font-medium text-gray-900">
            <li><a class="hover:text-black transition" href="/">Home</a></li>
            <li><a class="hover:text-black transition" href="/research/">Research Focus</a></li>
            <li><a class="hover:text-black transition" href="/publications/">Publications</a></li>
            <li><a class="hover:text-black transition" href="/people/">People</a></li>
          </ul>

          <!-- Mobile toggle -->
          <button
            id="nav-toggle"
            type="button"
            class="md:hidden inline-flex items-center justify-center rounded-lg p-2 ring-1 ring-black/10 hover:bg-gray-50"
            aria-controls="mobile-menu"
            aria-expanded="false"
            aria-label="Open menu"
          >
            <svg viewBox="0 0 24 24" class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="1.8">
              <path stroke-linecap="round" d="M4 7h16M4 12h16M4 17h16"/>
            </svg>
          </button>
        </nav>

        <!-- Mobile menu (absolute below the bar; hidden by default) -->
        <div
          id="mobile-menu"
          class="md:hidden absolute inset-x-0 top-full bg-white/95 backdrop-blur border-b shadow-lg hidden z-40"
        >
          <ul class="mx-auto max-w-6xl px-4 pb-4 pt-2 space-y-2 text-sm">
            <li><a class="block rounded px-3 py-2 hover:bg-gray-50" href="/">Home</a></li>
            <li><a class="block rounded px-3 py-2 hover:bg-gray-50" href="/research/">Research Focus</a></li>
            <li><a class="block rounded px-3 py-2 hover:bg-gray-50" href="/publications/">Publications</a></li>
            <li><a class="block rounded px-3 py-2 hover:bg-gray-50" href="/people/">People</a></li>

            <!-- Icon link -->
            <li>
              <a
                href="/"
                class="flex items-center gap-2 rounded px-3 py-2 hover:bg-gray-50"
                aria-label="PI-Vision home"
                title="PI-Vision home"
              >
                <img
                  src="/pivision-logo.png"
                  alt="PI-Vision logo"
                  width="20"
                  height="20"
                  class="h-14 w-14 object-contain select-none"
                  decoding="async"
                  loading="lazy"
                />
              </a>
            </li>
          </ul>
        </div>
      </div>
    </header>


    <script is:inline>
      (function () {
        function getEls() {
          return {
            btn:   document.getElementById('nav-toggle'),
            panel: document.getElementById('mobile-menu'),
          };
        }

        function setOpen(open) {
          const { btn, panel } = getEls();
          if (!btn || !panel) return;
          btn.setAttribute('aria-expanded', String(open));
          btn.setAttribute('aria-label', open ? 'Close menu' : 'Open menu');
          panel.classList.toggle('hidden', !open);
        }

        // Smooth expand/collapse of a panel with max-height + opacity
        function smoothToggle(panel, expand) {
          if (!panel) return;

          // Ensure we can measure
          panel.style.willChange = 'max-height, opacity';
          panel.style.overflow = 'hidden';

          if (expand) {
            // From collapsed → expanded
            // Start from current computed size
            panel.classList.remove('hidden');              // just in case
            panel.style.maxHeight = '0px';
            panel.style.opacity = '0';

            // Next frame: animate to content height
            requestAnimationFrame(() => {
              const h = panel.scrollHeight;
              panel.style.maxHeight = h + 'px';
              panel.style.opacity = '1';
            });

            // After transition, set to 'none' to allow content to expand naturally
            const onEnd = (e) => {
              if (e.propertyName !== 'max-height') return;
              panel.style.maxHeight = 'none'; // Changed from '' to 'none'
              panel.style.willChange = '';
              panel.removeEventListener('transitionend', onEnd);
            };
            panel.addEventListener('transitionend', onEnd);
          } else {
            // From expanded → collapsed
            const h = panel.scrollHeight;
            panel.style.maxHeight = h + 'px'; // set current height
            panel.style.opacity = '1';

            // Next frame: animate to 0
            requestAnimationFrame(() => {
              panel.style.maxHeight = '0px';
              panel.style.opacity = '0';
            });

            const onEnd = (e) => {
              if (e.propertyName !== 'max-height') return;
              // keep it collapsed
              panel.style.willChange = '';
              panel.removeEventListener('transitionend', onEnd);
            };
            panel.addEventListener('transitionend', onEnd);
          }
        }

        // Delegated click handling: works across SPA navigations
        document.addEventListener('click', (e) => {
          // Hamburger
          const toggle = e.target.closest('#nav-toggle');
          if (toggle) {
            const expanded = toggle.getAttribute('aria-expanded') === 'true';
            setOpen(!expanded);
            return;
          }
          const panel = document.getElementById('mobile-menu');
          if (panel && panel.contains(e.target) && e.target.closest('a[href]')) {
            setOpen(false);
            return;
          }

          // News "Show all / Show less"
          const newsBtn = e.target.closest('[data-news-toggle]');
          if (newsBtn) {
            const controlsId = newsBtn.getAttribute('aria-controls');
            if (!controlsId) return;
            const rest = document.getElementById(controlsId);
            if (!rest) return;

            const next = !(newsBtn.getAttribute('aria-expanded') === 'true');

            // Animate
            smoothToggle(rest, next);

            // Update all buttons tied to this panel (top & bottom)
            document.querySelectorAll(`[data-news-toggle][aria-controls="${controlsId}"]`).forEach((btn) => {
              btn.setAttribute('aria-expanded', String(next));
              const label = btn.querySelector('span:last-child');
              const chevron = btn.querySelector('span:first-child');
              if (label)   label.textContent   = next ? 'Show less' : 'Show all';
              if (chevron) chevron.textContent = next ? '‹'        : '›';
            });
            return;
          }
        });

        // Close after ClientRouter navigation & on Escape
        document.addEventListener('astro:after-swap', () => setOpen(false));
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') setOpen(false); });

        // Initialize closed on first load and on page-load events
        setOpen(false);
        document.addEventListener('astro:page-load', () => setOpen(false));
      })();
    </script>

    <main class={`mx-auto max-w-6xl px-4 ${noTopPad ? 'pt-0' : 'pt-10'} pb-10`} transition:name="content">
      <slot />
    </main>

    <footer class="border-t bg-gray-50/60 text-sm text-gray-600">
      <div class="mx-auto max-w-6xl px-4 py-10">
        <div class="grid gap-8 md:grid-cols-4">
          <!-- Brand + blurb -->
          <section>
            <div class="flex items-center gap-2 mb-3">
              <img src="/logo.svg" alt="" class="h-8 w-8" />
              <span class="font-semibold text-gray-900">PI-Vision</span>
            </div>
            <p class="leading-6">
              Physics-Informed Vision & Imaging at the University of Toronto
            </p>
          </section>

          <!-- Site links -->
          <section>
            <h2 class="text-gray-900 font-semibold mb-3">Explore</h2>
            <ul class="space-y-2">
              <li><a class="hover:underline" href="/">Home</a></li>
              <li><a class="hover:underline" href="/research/">Research Focus</a></li>
              <li><a class="hover:underline" href="/publications/">Publications</a></li>
              <li><a class="hover:underline" href="/people/">People</a></li>
            </ul>
          </section>

          <!-- Contact (optional) -->
          <section>
            <h2 class="text-gray-900 font-semibold mb-3">Contact</h2>
            <ul class="space-y-2">
              <!-- Replace with your actual group email/location if you want -->
              <li>University of Toronto</li>
              <li>Bahen Centre for Information Technology</li>
              <li>40 St. George St, Toronto, ON M5S 2E4</li>
            </ul>
          </section>

          <!-- Affiliations -->
          <section>
            <h2 class="text-gray-900 font-semibold mb-3">Affiliations</h2>
            <ul class="space-y-2">
              <li>
                <a class="inline-flex items-center gap-2 hover:underline"
                  href="https://www.utoronto.ca/" target="_blank" rel="noopener noreferrer">
                  <span>University of Toronto</span>
                </a>
              </li>
              <li>
                <a class="inline-flex items-center gap-2 hover:underline"
                  href="https://www.compimaging.dgp.toronto.edu/home/" target="_blank" rel="noopener noreferrer">
                  <span>Toronto Computational Imaging Group (TCIG)</span>
                </a>
              </li>
              <li>
                <a class="inline-flex items-center gap-2 hover:underline"
                  href="https://www.dgp.toronto.edu/" target="_blank" rel="noopener noreferrer">
                  <span>Dynamic Graphics Project (DGP)</span>
                </a>
              </li>
            </ul>

            <!-- Optional: logo strip -->
            <div class="mt-4 flex items-center gap-4">
              <!-- Drop logo files in /public/ and adjust names as needed -->

              <a href="https://www.utoronto.ca/" aria-label="University of Toronto" title="University of Toronto">
                <img src="/uoft.png" alt="University of Toronto"
                  class="h-8 w-auto object-contain" loading="lazy" decoding="async" />
              </a>
              <a href="https://www.compimaging.dgp.toronto.edu/home/" aria-label="TCIG home" title="TCIG home">
                <img src="/tcig_webicon_full.png" alt="TCIG"
                  class="h-8 w-auto object-contain" loading="lazy" decoding="async" />
              </a>
              <a href="https://www.dgp.toronto.edu/" aria-label="DGP home" title="DGP home">
                <img src="/dgp.svg" alt="DGP"
                  class="h-8 w-auto object-contain" loading="lazy" decoding="async" />
              </a>
            </div>
          </section>
        </div>
      </div>

      <!-- Bottom bar -->
      <div class="border-t">
        <div class="mx-auto max-w-6xl px-4 py-6 flex flex-col sm:flex-row gap-2 sm:items-center sm:justify-between">
          <p>© {new Date().getFullYear()} PI-Vision.</p>
          <p class="text-gray-500">
            Design elements are inspired by the
            <a href="https://www.scenerepresentations.org/" class="underline hover:text-gray-700">MIT Scene Representation Group</a>.
            Gravitational lensing video based on a shader by
            <a href="https://www.shadertoy.com/view/tsBXW3" class="underline hover:text-gray-700">set113</a>.
          </p>
        </div>
      </div>
    </footer>

    <script is:inline type="module">
      const FG_SELECTOR = '.gallery-trigger';
      const FG_BOUND_ATTR = 'fgBound';

      const bindFocusGrid = () => {
        document.querySelectorAll(FG_SELECTOR).forEach((trigger) => {
          if (trigger.dataset[FG_BOUND_ATTR] === 'true') return;
          trigger.dataset[FG_BOUND_ATTR] = 'true';

          const href = trigger.getAttribute('data-href');
          const gallery = trigger.nextElementSibling;
          let hideTimeout;

          if (gallery?.classList?.contains('fg-gallery')) {
            const openGallery = () => {
              clearTimeout(hideTimeout);
              trigger.classList.add('fg-open');
              gallery.classList.add('fg-open');
            };

            const scheduleClose = () => {
              clearTimeout(hideTimeout);
              hideTimeout = window.setTimeout(() => {
                trigger.classList.remove('fg-open');
                gallery.classList.remove('fg-open');
              }, 120);
            };

            trigger.addEventListener('mouseenter', openGallery);
            trigger.addEventListener('mouseleave', scheduleClose);
            trigger.addEventListener('focusin', openGallery);
            trigger.addEventListener('focusout', scheduleClose);
            gallery.addEventListener('mouseenter', openGallery);
            gallery.addEventListener('mouseleave', scheduleClose);
            gallery.addEventListener('focusin', openGallery);
            gallery.addEventListener('focusout', scheduleClose);
          }

          trigger.addEventListener('click', (e) => {
            if (e.target.closest('a[href]')) return;
            if (href) window.location.href = href;
          });
        });
      };

      const scheduleFocusGrid = () => window.requestAnimationFrame(bindFocusGrid);
      scheduleFocusGrid();
      document.addEventListener('astro:page-load', scheduleFocusGrid);
      document.addEventListener('astro:after-swap', scheduleFocusGrid);

      const scrollToHash = () => {
        const hash = window.location.hash.replace(/^#/, '');
        if (!hash) return;
        const el = document.getElementById(decodeURIComponent(hash));
        if (!el) return;
        requestAnimationFrame(() => {
          el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      };

      window.addEventListener('load', scrollToHash);
      document.addEventListener('astro:page-load', () => setTimeout(scrollToHash, 0));
      document.addEventListener('astro:after-swap', () => setTimeout(scrollToHash, 0));
    </script>
  </body>
</html>
